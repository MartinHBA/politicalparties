<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QXR2KE4GRN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-QXR2KE4GRN');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Political Parties and Seats</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="center-align">Political Parties and Seats</h1>
        <div class="input-field" style="display: inline-block; vertical-align: middle;">
            <select id="source">
                <option value="AKO">AKO</option>
                <option value="Focus">FOCUS</option>
                <option value="IPSOS">IPSOS</option>
            </select>
            <label>Source</label>
        </div>
        <button class="btn waves-effect waves-light" type="button" onclick="fetchParties()">Fetch</button>
        <span id="fetch-date" style="margin-left: 15px;"></span>
        <form id="party-form">
            <div class="row">
                <div class="input-field col s4">
                    <input type="text" id="party1" required>
                    <label for="party1">Party 1</label>
                </div>
                <div class="input-field col s4">
                    <input type="number" id="seats1" min="0" required>
                    <label for="seats1">Seats for Party 1</label>
                </div>
                <div class="input-field col s4">
                    <input type="color" id="color1" value="#1e88e5">
                </div>
            </div>
            <div class="row">
                <div class="input-field col s4">
                    <input type="text" id="party2" required>
                    <label for="party2">Party 2</label>
                </div>
                <div class="input-field col s4">
                    <input type="number" id="seats2" min="0" required>
                    <label for="seats2">Seats for Party 2</label>
                </div>
                <div class="input-field col s4">
                    <input type="color" id="color2" value="#5e35b1">
                </div>
            </div>
            <div class="row">
                <div class="input-field col s4">
                    <input type="text" id="party3" required>
                    <label for="party3">Party 3</label>
                </div>
                <div class="input-field col s4">
                    <input type="number" id="seats3" min="0" required>
                    <label for="seats3">Seats for Party 3</label>
                </div>
                <div class="input-field col s4">
                    <input type="color" id="color3" value="#f4511e">
                </div>
            </div>
            <div id="extra-fields"></div>
            <div class="row">
                <div class="input-field col s4">
                    <button class="btn waves-effect waves-light" type="button" id="add-another-party" onclick="addPartyField()">Add Another
                        Party</button>
                </div>
                <div class="input-field col s4">
                    <button class="btn waves-effect waves-light" type="submit">Submit</button>
                    <button class="btn waves-effect waves-light" type="button"
                        onclick="exclusionsForm(event)">Exclusions</button>
                </div>
                <div class="input-field col s4">
                </div>
            </div>
        </form>
    </div>
    <script>

        let fieldCounter = 3;
        async function fetchParties() {
            try {
                const source = document.getElementById('source').value;
                const response = await fetch(`/fetch?source=${source}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                const parties = result.parties;
                const date = result.date;
                document.getElementById("fetch-date").innerText = `Source data: ${date}`; // Update this line


                // Remove all existing rows
                const extraFields = document.getElementById("extra-fields");
                extraFields.innerHTML = '';
                // Reset fieldCounter
                fieldCounter = 3;


                parties.forEach((party, index) => {
                    if (index < 3) {
                        document.getElementById(`party${index + 1}`).value = party.Name;
                        document.getElementById(`seats${index + 1}`).value = party.Seats;
                        document.getElementById(`color${index + 1}`).value = party.Color; // Add this line
                        document.querySelector(`label[for="party${index + 1}"]`).classList.add('active');
                        document.querySelector(`label[for="seats${index + 1}"]`).classList.add('active');
                    } else {
                        addPartyField();
                        document.getElementById(`party${index + 1}`).value = party.Name;
                        document.getElementById(`seats${index + 1}`).value = party.Seats;
                        document.getElementById(`color${index + 1}`).value = party.Color; // Add this line
                        document.querySelector(`label[for="party${index + 1}"]`).classList.add('active');
                        document.querySelector(`label[for="seats${index + 1}"]`).classList.add('active');
                    }
                    // since it's fetched, hide "add another party button"
                    document.getElementById("add-another-party").style.display = "none";

                });

            } catch (error) {
                console.error("Fetch error:", error);
            }
        }


        function getRandomColor() {
            let letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function populateFormAndSubmit(parties) {
            const partiesInput = document.getElementById("parties");
            partiesInput.value = JSON.stringify(parties);

            const form = document.getElementById("main-form");
            form.submit();
        }


        function submitForm(event) {
            event.preventDefault();
            let parties = [];
            for (let i = 1; i <= fieldCounter; i++) {
                let party = document.getElementById(`party${i}`).value;
                let seats = parseInt(document.getElementById(`seats${i}`).value, 10);
                let color = document.getElementById(`color${i}`).value;
                parties.push({ name: party, seats: seats, color: color });
            }

            fetch('/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `parties=${encodeURIComponent(JSON.stringify(parties))}`,
            })
                .then((response) => response.json())
                .then((data) => {
                    localStorage.setItem('chartData', JSON.stringify(data));
                    window.location.href = '/results';
                })
                .catch((error) => console.error(error));
        }


        function exclusionsForm(event) {
            event.preventDefault();
            let partyNames = [];
            for (let i = 1; i <= fieldCounter; i++) {
                let party = document.getElementById(`party${i}`).value;
                partyNames.push(party);
            }
            let partiesData = [];
            for (let i = 1; i <= fieldCounter; i++) {
                let party = document.getElementById(`party${i}`).value;
                let seats = parseInt(document.getElementById(`seats${i}`).value, 10);
                let color = document.getElementById(`color${i}`).value;
                partiesData.push({ name: party, seats: seats, color: color });
            }

            localStorage.setItem('partyNames', JSON.stringify(partyNames));
            localStorage.setItem('partiesData', JSON.stringify(partiesData));
            window.location.href = '/exclusions';
        }


        function addPartyField() {
            fieldCounter++;
            let extraFields = document.getElementById("extra-fields");

            let rowDiv = document.createElement("div");
            rowDiv.className = "row";

            let partyDiv = document.createElement("div");
            partyDiv.className = "input-field col s4";
            partyDiv.innerHTML = `
        <input type="text" id="party${fieldCounter}" required>
        <label for="party${fieldCounter}">Party ${fieldCounter}</label>`;
            rowDiv.appendChild(partyDiv);

            let seatsDiv = document.createElement("div");
            seatsDiv.className = "input-field col s4";
            seatsDiv.innerHTML = `
        <input type="number" id="seats${fieldCounter}" min="0" required>
        <label for="seats${fieldCounter}">Seats for Party ${fieldCounter}</label>`;
            rowDiv.appendChild(seatsDiv);

            let colorDiv = document.createElement("div");
            colorDiv.className = "input-field col s4";
            colorDiv.innerHTML = `
        <input type="color" id="color${fieldCounter}" value="${getRandomColor()}">`;
            rowDiv.appendChild(colorDiv);

            extraFields.appendChild(rowDiv);
        }

        document.getElementById("party-form").addEventListener("submit", submitForm);
        document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('select');
            var instances = M.FormSelect.init(elems);
        });

    </script>

</body>

</html>